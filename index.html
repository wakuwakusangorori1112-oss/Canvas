<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Character Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.344.0",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
      }
    }
    </script>
</head>
<body class="bg-slate-900 text-white">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useMemo, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { 
            getAuth, 
            signInWithCustomToken,
            signInAnonymously, 
            onAuthStateChanged 
        } from 'firebase/auth';
        import { 
            getFirestore, 
            collection, 
            doc, 
            addDoc, 
            updateDoc, 
            onSnapshot, 
            deleteDoc,
            writeBatch
        } from 'firebase/firestore';
        import { 
            Plus, Trash2, Tag, BarChart3, Play, Settings, RotateCcw, 
            Frown, Smile, Meh, AlertCircle, CheckCircle2, X, Search, User, Share2,
            Image as ImageIcon, Upload, Wifi, WifiOff, Database, ExternalLink, Lock,
            FileText, Copy, Sparkles, Skull, ThumbsUp, Home, Edit2, FileSpreadsheet
        } from 'lucide-react';

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyCjLdydnVAYgHh0iKVtpskoy-W4HpFDDe4",
            authDomain: "test1-7c377a.firebaseapp.com",
            projectId: "test1-7c377a",
            storageBucket: "test1-7c377a.firebasestorage.app",
            messagingSenderId: "559194725567",
            appId: "1:559194725567:web:d6a3109709fe62ee8fba0a"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'char-analyzer-public'; 

        // --- エラーガイドコンポーネント ---
        const CriticalErrorGuide = ({ type }) => {
            if (type === 'firestore_not_created') {
                return (
                    <div className="fixed inset-0 bg-slate-900 z-50 flex flex-col items-center justify-center p-8 text-center overflow-y-auto">
                        <div className="bg-slate-800 p-8 rounded-3xl max-w-lg border border-red-500/30 shadow-2xl">
                            <div className="w-20 h-20 bg-red-500/20 text-red-500 rounded-full flex items-center justify-center mx-auto mb-6">
                                <Database size={40} />
                            </div>
                            <h2 className="text-2xl font-bold mb-4">データベースが見つかりません</h2>
                            <p className="text-slate-300 mb-6 leading-relaxed">
                                Firebaseコンソールでデータベースを作成してください。<br/>
                                作成済みの場合、反映に数分かかることがあります。
                            </p>
                            <button onClick={() => window.location.reload()} className="w-full py-3 bg-blue-600 rounded-xl font-bold hover:bg-blue-500 transition-colors">
                                再読み込み
                            </button>
                        </div>
                    </div>
                );
            }
            if (type === 'permission_denied') {
                return (
                    <div className="fixed inset-0 bg-slate-900 z-50 flex flex-col items-center justify-center p-8 text-center overflow-y-auto">
                        <div className="bg-slate-800 p-8 rounded-3xl max-w-lg border border-yellow-500/30 shadow-2xl">
                            <div className="w-20 h-20 bg-yellow-500/20 text-yellow-500 rounded-full flex items-center justify-center mx-auto mb-6">
                                <Lock size={40} />
                            </div>
                            <h2 className="text-2xl font-bold mb-4">書き込み権限がありません</h2>
                            <p className="text-slate-300 mb-4 leading-relaxed text-sm">
                                データベース作成時に「本番モード」を選んだ可能性があります。<br/>
                                以下の手順で「テストモード」に変更してください。
                            </p>
                            <div className="bg-slate-900 text-left p-6 rounded-xl border border-slate-700 text-xs space-y-2 mb-6 font-mono text-slate-400">
                                <p>1. Firebaseコンソールの「Firestore Database」を開く</p>
                                <p>2. 上部の<strong>「ルール (Rules)」</strong>タブをクリック</p>
                                <p>3. 以下のコードに書き換えて「公開」を押す：</p>
                                <div className="bg-black p-2 rounded text-green-400 my-2">
                                    allow read, write: if true;
                                </div>
                            </div>
                            <button onClick={() => window.location.reload()} className="w-full py-3 bg-yellow-600 rounded-xl font-bold hover:bg-yellow-500 transition-colors">
                                設定したら再読み込み
                            </button>
                        </div>
                    </div>
                );
            }
            return null;
        };

        // --- 円グラフコンポーネント ---
        const SimplePieChart = ({ data }) => {
            const total = data.reduce((acc, [_, count]) => acc + count, 0);
            let currentAngle = 0;
            const colors = ['#EF4444', '#DC2626', '#F97316', '#F59E0B', '#10B981', '#3B82F6', '#6366F1', '#8B5CF6', '#EC4899', '#64748B'];

            if (total === 0) return null;

            return (
                <div className="flex flex-row items-center justify-center gap-6 mb-8 bg-slate-900/50 p-6 rounded-3xl border border-slate-700">
                    <div className="w-32 h-32 relative shrink-0">
                        <svg viewBox="0 0 100 100" className="transform -rotate-90 w-full h-full drop-shadow-xl">
                            {data.map(([tag, count], i) => {
                                const percentage = count / total;
                                const angle = percentage * 360;
                                const startAngle = currentAngle;
                                const endAngle = currentAngle + angle;
                                currentAngle += angle;

                                const r = 50;
                                const x1 = 50 + r * Math.cos(Math.PI * startAngle / 180);
                                const y1 = 50 + r * Math.sin(Math.PI * startAngle / 180);
                                const x2 = 50 + r * Math.cos(Math.PI * endAngle / 180);
                                const y2 = 50 + r * Math.sin(Math.PI * endAngle / 180);
                                
                                if (data.length === 1) return <circle key={tag} cx="50" cy="50" r="50" fill={colors[i % colors.length]} />;

                                const largeArc = angle > 180 ? 1 : 0;
                                const d = `M 50 50 L ${x1} ${y1} A 50 50 0 ${largeArc} 1 ${x2} ${y2} Z`;

                                return <path key={tag} d={d} fill={colors[i % colors.length]} stroke="#0f172a" strokeWidth="1" />;
                            })}
                        </svg>
                    </div>
                    <div className="flex-1 space-y-2">
                        {data.map(([tag, count], i) => (
                            <div key={tag} className="flex items-center justify-between text-xs">
                                <div className="flex items-center gap-2">
                                    <div className="w-3 h-3 rounded-full shadow-sm" style={{ backgroundColor: colors[i % colors.length] }}></div>
                                    <span className="text-slate-200 font-bold">{tag}</span>
                                </div>
                                <span className="text-slate-400 font-mono">Score: {count}</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [characters, setCharacters] = useState([]);
            const [results, setResults] = useState([]);
            const [mode, setMode] = useState('home'); 
            const [swipeIndex, setSwipeIndex] = useState(0);
            const [loading, setLoading] = useState(true);
            const [isProcessingImage, setIsProcessingImage] = useState(false);
            const [authError, setAuthError] = useState(null);
            const [criticalError, setCriticalError] = useState(null);
            const [galleryTab, setGalleryTab] = useState('dislike');
            const [editingResult, setEditingResult] = useState(null); 

            // スワイプ用
            const [offsetX, setOffsetX] = useState(0);
            const [offsetY, setOffsetY] = useState(0);
            const [isDragging, setIsDragging] = useState(false);
            const startX = useRef(0);
            const startY = useRef(0);

            // フォーム用
            const [newChar, setNewChar] = useState({ name: '', source: '', imageUrl: '', tags: [] });
            const [editingCharId, setEditingCharId] = useState(null); // 編集中のキャラクターID（新規登録以外）
            
            // タグリスト
            const suggestedTags = [
                "不気味の谷", "目が笑っていない", "色が派手すぎ", "プロポーションが歪", 
                "あざとい", "無機質", "人間味がありすぎ", "左右非対称",
                "集合体", "粘液質", "爬虫類的", "ピエロ", "日本人形", 
                "目が大きすぎる", "動きが予測不能", "鋭利", "威圧的",
                "清潔感がない", "作り物めいている", "表情が固定"
            ];
            const fileInputRef = useRef(null);
            const csvInputRef = useRef(null);

            // 1. Authentication
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        await signInAnonymously(auth);
                    } catch (err) {
                        console.error("Auth error:", err);
                        if (err.code === 'auth/operation-not-allowed' || err.code === 'auth/admin-restricted-operation') {
                            setAuthError("Firebaseコンソールで「匿名ログイン(Anonymous)」が無効になっています。有効にしてください。");
                        } else {
                            setAuthError(`接続エラー: ${err.message}`);
                        }
                    }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, (user) => {
                    if (user) setUser(user);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            // 2. Real-time Data Sync
            useEffect(() => {
                if (!user) return;

                const handleError = (err) => {
                    console.error("Firestore Error:", err);
                    if (err.message && err.message.includes("Cloud Firestore API has not been used")) {
                        setCriticalError("firestore_not_created");
                    } else if (err.code === 'permission-denied') {
                        setCriticalError("permission_denied");
                    } else {
                        setAuthError(`読み込みエラー: ${err.message}`);
                    }
                };

                const charCol = collection(db, 'artifacts', appId, 'public', 'data', 'characters');
                const unsubChars = onSnapshot(charCol, (snapshot) => {
                    // 更新日順にソートしたい場合はここでsort
                    const charList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a,b) => b.createdAt - a.createdAt);
                    setCharacters(charList);
                    setAuthError(null);
                    setCriticalError(null); 
                }, handleError);

                const resultCol = collection(db, 'artifacts', appId, 'public', 'data', 'results');
                const unsubResults = onSnapshot(resultCol, (snapshot) => {
                    const resultList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setResults(resultList);
                }, handleError);

                return () => {
                    unsubChars();
                    unsubResults();
                };
            }, [user]);

            // 画像処理
            const processImage = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            const MAX_SIZE = 800; 
                            let width = img.width;
                            let height = img.height;
                            if (width > height) {
                                if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; }
                            } else {
                                if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; }
                            }
                            canvas.width = width;
                            canvas.height = height;
                            ctx.drawImage(img, 0, 0, width, height);
                            resolve(canvas.toDataURL('image/jpeg', 0.8));
                        };
                        img.onerror = reject;
                        img.src = e.target.result;
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            };

            const handleFileChange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                try {
                    setIsProcessingImage(true);
                    const base64Image = await processImage(file);
                    setNewChar(prev => ({ ...prev, imageUrl: base64Image }));
                } catch (err) {
                    alert("画像の処理に失敗しました。");
                } finally {
                    setIsProcessingImage(false);
                }
            };

            // CSVインポート処理
            const handleCSVImport = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (event) => {
                    const text = event.target.result;
                    const lines = text.split(/\r\n|\n/);
                    let count = 0;
                    
                    try {
                        const batch = writeBatch(db);
                        const charCol = collection(db, 'artifacts', appId, 'public', 'data', 'characters');

                        lines.forEach((line) => {
                            const parts = line.split(',');
                            // 最低でも名前が必要
                            if (parts.length > 0 && parts[0].trim() !== '') {
                                // ヘッダー行っぽいものはスキップ（簡易判定）
                                if (parts[0].includes('キャラクター名') || parts[0].includes('名前')) return;

                                const name = parts[0].trim();
                                const source = parts[1] ? parts[1].trim() : '';
                                const tags = parts.slice(2).map(t => t.trim()).filter(t => t !== '');
                                
                                const newDocRef = doc(charCol); // 新しいIDを生成
                                batch.set(newDocRef, {
                                    name,
                                    source,
                                    tags,
                                    imageUrl: '', // CSVからは画像は空で登録
                                    createdAt: Date.now(),
                                    createdBy: user.uid
                                });
                                count++;
                            }
                        });

                        await batch.commit();
                        alert(`${count}件のキャラクターを一括登録しました！\nリストから画像を設定してください。`);
                    } catch (err) {
                        console.error("CSV Import Error:", err);
                        alert("CSVのインポートに失敗しました。");
                    }
                    if (csvInputRef.current) csvInputRef.current.value = '';
                };
                reader.readAsText(file);
            };

            // Actions
            const saveCharacter = async () => {
                if (!newChar.name) return;
                if (!user) {
                    alert(authError || "ログイン処理中です。数秒待ってから再度お試しください。");
                    return;
                }
                try {
                    const charCol = collection(db, 'artifacts', appId, 'public', 'data', 'characters');
                    
                    if (editingCharId) {
                        // 更新モード
                        const ref = doc(db, 'artifacts', appId, 'public', 'data', 'characters', editingCharId);
                        await updateDoc(ref, {
                            ...newChar,
                            updatedAt: Date.now()
                        });
                        alert("更新しました！");
                        setEditingCharId(null);
                    } else {
                        // 新規登録モード
                        await addDoc(charCol, { ...newChar, createdAt: Date.now(), createdBy: user.uid });
                        alert("保存しました！");
                    }
                    setNewChar({ name: '', source: '', imageUrl: '', tags: [] }); 
                } catch (err) {
                    console.error("Save error:", err);
                    alert(`保存失敗: ${err.message}`);
                }
            };

            // 編集モードに入る
            const startEditCharacter = (char) => {
                setNewChar({
                    name: char.name,
                    source: char.source || '',
                    imageUrl: char.imageUrl || '',
                    tags: char.tags || []
                });
                setEditingCharId(char.id);
                // ページ上部にスクロール
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            // 編集キャンセル
            const cancelEdit = () => {
                setNewChar({ name: '', source: '', imageUrl: '', tags: [] });
                setEditingCharId(null);
            };

            const deleteCharacter = async (id) => {
                if(!confirm("本当に削除しますか？")) return;
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'characters', id));
                } catch (err) {
                    console.error("Delete error:", err);
                }
            };

            const deleteResult = async (id, e) => {
                e.stopPropagation();
                if (!confirm("この判定結果を削除しますか？")) return;
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'results', id));
                } catch (err) {
                    console.error("Delete result error:", err);
                    alert("削除に失敗しました");
                }
            };

            const updateResult = async (id, newRating) => {
                try {
                    const ref = doc(db, 'artifacts', appId, 'public', 'data', 'results', id);
                    await updateDoc(ref, { rating: newRating });
                    setEditingResult(null); 
                } catch (err) {
                    console.error("Update error:", err);
                    alert("更新に失敗しました");
                }
            };

            const resetMyResults = async () => {
                if (!confirm("あなたの分析結果を全て削除してリセットします。\nよろしいですか？")) return;
                if (!user) return;
                
                const batch = writeBatch(db);
                const myRes = results.filter(r => r.userId === user.uid);
                
                if (myRes.length === 0) {
                    alert("削除するデータがありません");
                    return;
                }

                myRes.forEach(r => {
                    const ref = doc(db, 'artifacts', appId, 'public', 'data', 'results', r.id);
                    batch.delete(ref);
                });

                try {
                    await batch.commit();
                    alert("リセットしました！");
                    setMode('swipe');
                    setSwipeIndex(0);
                } catch (err) {
                    console.error("Reset error:", err);
                    alert("リセットに失敗しました");
                }
            };

            const handleDecision = async (rating) => {
                if (swipeIndex >= characters.length) return;
                const char = characters[swipeIndex];
                
                if (rating === 'not_dislike') setOffsetX(500); 
                else if (rating === 'dislike') setOffsetX(-500); 
                else if (rating === 'super_dislike') setOffsetY(-500); 
                
                if (user) {
                    try {
                        const resultCol = collection(db, 'artifacts', appId, 'public', 'data', 'results');
                        await addDoc(resultCol, {
                            characterId: char.id,
                            characterName: char.name,
                            characterSource: char.source || '',
                            imageUrl: char.imageUrl,
                            tags: char.tags,
                            rating: rating,
                            userId: user.uid,
                            timestamp: Date.now()
                        });
                    } catch (err) {
                        console.error("Result save error:", err);
                    }
                }

                setTimeout(() => {
                    setOffsetX(0);
                    setOffsetY(0);
                    if (swipeIndex < characters.length - 1) {
                        setSwipeIndex(prev => prev + 1);
                    } else {
                        setMode('analysis');
                    }
                }, 200);
            };

            const copyToClipboard = async (text) => {
                try {
                    if (navigator.clipboard && window.isSecureContext) {
                        await navigator.clipboard.writeText(text);
                        return; 
                    }
                } catch (err) {
                    console.warn("Clipboard API failed, switching to fallback...", err);
                }

                return new Promise((resolve, reject) => {
                    const textArea = document.createElement("textarea");
                    textArea.value = text;
                    textArea.style.position = "fixed";
                    textArea.style.left = "-9999px";
                    textArea.style.top = "0";
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    try {
                        const successful = document.execCommand('copy');
                        if (successful) resolve();
                        else reject(new Error("Copy command failed"));
                    } catch (err) {
                        reject(err);
                    } finally {
                        document.body.removeChild(textArea);
                    }
                });
            };

            const generateAIReport = () => {
                if (!analysis || analysis.length === 0) {
                    alert("分析データがありません。");
                    return;
                }
                
                let report = "【キャラクター苦手傾向分析データ】\n";
                report += "以下のデータを元に、この人の深層心理や、なぜこういった特徴を不気味に感じるのか、心理学的・美学的な観点から分析してください。\n\n";
                
                report += "■苦手スコア（不快度が高い要素）\n";
                report += "※スコアは「本当に嫌い」=3点、「嫌い」=1点で算出しています。\n";
                analysis.forEach(([tag, score], index) => {
                    report += `${index + 1}. ${tag}: ${score}点\n`;
                });
                
                const superDislikeChars = myResults.filter(r => r.rating === 'super_dislike');
                if (superDislikeChars.length > 0) {
                    report += "\n■【要注意】「本当に嫌い」と判定したキャラクター（強い拒絶反応）\n";
                    superDislikeChars.forEach(c => {
                        report += `- ${c.characterName} ${c.characterSource ? '(' + c.characterSource + ')' : ''} [タグ: ${c.tags ? c.tags.join(', ') : 'なし'}]\n`;
                    });
                }

                const dislikeChars = myResults.filter(r => r.rating === 'dislike');
                if (dislikeChars.length > 0) {
                    report += "\n■「嫌い」と判定したキャラクター\n";
                    dislikeChars.slice(0, 15).forEach(c => {
                        report += `- ${c.characterName} ${c.characterSource ? '(' + c.characterSource + ')' : ''}\n`;
                    });
                }

                const notDislikeChars = myResults.filter(r => r.rating === 'not_dislike' || r.rating === 'like');
                if (notDislikeChars.length > 0) {
                    report += "\n■（参考）「嫌いじゃない」と判定したキャラクター（比較用）\n";
                    notDislikeChars.slice(0, 10).forEach(c => {
                        report += `- ${c.characterName}\n`;
                    });
                }

                copyToClipboard(report)
                    .then(() => alert("AI分析用プロンプトをコピーしました！\nChatGPTやGeminiに貼り付けて聞いてみてください。"))
                    .catch(err => {
                        console.error('Copy failed', err);
                        alert("コピーに失敗しました。画面上のデータを手動でコピーしてください。");
                    });
            };

            const onStart = (e) => { 
                setIsDragging(true); 
                startX.current = e.type.includes('touch') ? e.touches[0].clientX : e.clientX; 
                startY.current = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
            };
            const onMove = (e) => { 
                if (!isDragging) return; 
                const currentX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX; 
                const currentY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
                setOffsetX(currentX - startX.current);
                setOffsetY(currentY - startY.current);
            };
            const onEnd = () => { 
                if (!isDragging) return; 
                setIsDragging(false);
                if (offsetY < -100 && Math.abs(offsetY) > Math.abs(offsetX)) {
                    handleDecision('super_dislike'); 
                } else if (offsetX > 100) {
                    handleDecision('not_dislike'); 
                } else if (offsetX < -100) {
                    handleDecision('dislike'); 
                } else {
                    setOffsetX(0);
                    setOffsetY(0);
                }
            };

            const myResults = useMemo(() => {
                if (!user) return [];
                return results.filter(r => r.userId === user.uid);
            }, [results, user]);

            const analysis = useMemo(() => {
                const tagScores = {};
                myResults.forEach(r => {
                    let weight = 0;
                    if (r.rating === 'super_dislike') weight = 3;
                    else if (r.rating === 'dislike') weight = 1;
                    else return; 

                    r.tags?.forEach(tag => { 
                        tagScores[tag] = (tagScores[tag] || 0) + weight; 
                    }); 
                });
                return Object.entries(tagScores).sort((a, b) => b[1] - a[1]).slice(0, 10);
            }, [myResults]);

            if (criticalError) return <CriticalErrorGuide type={criticalError} />;
            if (loading) return <div className="min-h-screen bg-slate-900 flex items-center justify-center text-white">読み込み中...</div>;

            return (
                <div className="min-h-screen bg-slate-900 text-white font-sans overflow-hidden flex flex-col">
                    <header className="p-4 border-b border-slate-800 flex justify-between items-center bg-slate-900/80 backdrop-blur-md z-30">
                        <button onClick={() => setMode('home')} className="flex items-center gap-2 hover:opacity-80 transition-opacity">
                            <h1 className="text-xl font-black tracking-tighter flex items-center gap-2">
                                <div className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center italic">C</div>
                                CHAR-LAB
                            </h1>
                        </button>
                        <div className="flex items-center gap-2">
                            {user ? (
                                <div className="text-xs text-green-400 flex items-center gap-1 bg-green-900/20 px-2 py-1 rounded-full border border-green-900">
                                    <Wifi size={12} /> Online
                                </div>
                            ) : (
                                <div className="text-xs text-red-400 flex items-center gap-1 bg-red-900/20 px-2 py-1 rounded-full border border-red-900 animate-pulse">
                                    <WifiOff size={12} /> Connecting...
                                </div>
                            )}
                            <div className="flex bg-slate-800 p-1 rounded-xl ml-2">
                                <button onClick={() => setMode('setup')} className={`p-2 rounded-lg transition-all ${mode === 'setup' ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-400'}`}><Settings size={20} /></button>
                                <button onClick={() => setMode('analysis')} className={`p-2 rounded-lg transition-all ${mode === 'analysis' ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-400'}`}><BarChart3 size={20} /></button>
                            </div>
                        </div>
                    </header>

                    {authError && (
                        <div className="bg-red-500/10 border-b border-red-500/50 p-2 text-center text-red-200 text-xs">
                            <p className="font-bold flex items-center justify-center gap-2">
                                <AlertCircle size={14} /> {authError}
                            </p>
                        </div>
                    )}

                    <main className="flex-1 relative flex flex-col items-center justify-center p-4 overflow-y-auto">
                        
                        {/* HOME MODE */}
                        {mode === 'home' && (
                            <div className="flex flex-col items-center justify-center text-center space-y-8 max-w-md w-full animate-in fade-in zoom-in duration-500">
                                <div className="space-y-4">
                                    <div className="w-24 h-24 bg-gradient-to-br from-blue-500 to-purple-600 rounded-3xl mx-auto flex items-center justify-center shadow-2xl shadow-blue-500/20">
                                        <Search size={48} className="text-white" />
                                    </div>
                                    <h1 className="text-4xl font-black tracking-tighter">
                                        CHARACTER<br/>ANALYZER
                                    </h1>
                                    <p className="text-slate-400 text-sm leading-relaxed px-4">
                                        「なんとなく苦手」を言語化しよう。<br/>
                                        直感的なスワイプ操作で、<br/>
                                        あなたの深層心理を分析します。
                                    </p>
                                </div>

                                <div className="w-full space-y-4 px-4">
                                    <button 
                                        onClick={() => { setSwipeIndex(0); setMode('swipe'); }}
                                        className="w-full py-4 bg-white text-slate-900 rounded-2xl font-bold text-lg shadow-xl hover:bg-slate-100 transition-all flex items-center justify-center gap-2"
                                    >
                                        <Play size={20} className="fill-slate-900" />
                                        診断を始める
                                    </button>
                                    
                                    <div className="pt-4 border-t border-slate-800">
                                        <p className="text-xs text-slate-500 mb-3">管理者・登録用メニュー</p>
                                        <div className="grid grid-cols-2 gap-3">
                                            <button 
                                                onClick={() => setMode('setup')}
                                                className="py-3 bg-slate-800 text-slate-300 rounded-xl font-bold text-sm hover:bg-slate-700 transition-colors flex items-center justify-center gap-2"
                                            >
                                                <Settings size={16} /> キャラ登録
                                            </button>
                                            <button 
                                                onClick={() => setMode('analysis')}
                                                className="py-3 bg-slate-800 text-slate-300 rounded-xl font-bold text-sm hover:bg-slate-700 transition-colors flex items-center justify-center gap-2"
                                            >
                                                <BarChart3 size={16} /> 分析を見る
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {mode === 'setup' && (
                            <div className="w-full max-w-md space-y-6 pb-24">
                                <div className="bg-slate-800 p-6 rounded-3xl border border-slate-700 shadow-xl">
                                    <h2 className="text-lg font-bold mb-4 flex items-center gap-2 text-blue-400">
                                        <Plus size={20} /> 分析対象を{editingCharId ? '編集' : '登録'}
                                    </h2>
                                    
                                    {/* CSVインポートエリア (新規登録時のみ) */}
                                    {!editingCharId && (
                                        <div className="mb-6 p-4 bg-slate-900/50 rounded-xl border border-slate-600 border-dashed">
                                            <div className="flex flex-col gap-2">
                                                <p className="text-xs font-bold text-slate-400 flex items-center gap-1">
                                                    <FileSpreadsheet size={14}/> CSV一括登録
                                                </p>
                                                <p className="text-[10px] text-slate-500">
                                                    形式: キャラ名, 作品名, タグ1, タグ2...
                                                </p>
                                                <input
                                                    type="file"
                                                    ref={csvInputRef}
                                                    accept=".csv"
                                                    onChange={handleCSVImport}
                                                    className="hidden"
                                                />
                                                <button 
                                                    onClick={() => csvInputRef.current?.click()}
                                                    className="w-full py-2 bg-slate-700 hover:bg-slate-600 text-slate-300 text-xs rounded-lg transition-colors flex items-center justify-center gap-2"
                                                >
                                                    <Upload size={14} /> CSVファイルを選択してアップロード
                                                </button>
                                            </div>
                                        </div>
                                    )}

                                    <div className="space-y-4">
                                        <input 
                                            placeholder="キャラ名"
                                            className="w-full bg-slate-700 border-none rounded-2xl p-4 text-white placeholder:text-slate-500 focus:ring-2 focus:ring-blue-500"
                                            value={newChar.name}
                                            onChange={e => setNewChar({...newChar, name: e.target.value})}
                                        />
                                        <input 
                                            placeholder="作品名・詳細 (例: 〇〇のアニメ)"
                                            className="w-full bg-slate-700 border-none rounded-2xl p-4 text-white placeholder:text-slate-500 focus:ring-2 focus:ring-blue-500"
                                            value={newChar.source}
                                            onChange={e => setNewChar({...newChar, source: e.target.value})}
                                        />
                                        <div className="space-y-2">
                                            <div className="flex gap-2">
                                                <input 
                                                    placeholder="画像URL (空欄で登録し、後で編集可)"
                                                    className="flex-1 bg-slate-700 border-none rounded-2xl p-4 text-white placeholder:text-slate-500 focus:ring-2 focus:ring-blue-500 text-sm"
                                                    value={newChar.imageUrl.startsWith('data:') ? '' : newChar.imageUrl}
                                                    onChange={e => setNewChar({...newChar, imageUrl: e.target.value})}
                                                    disabled={newChar.imageUrl.startsWith('data:')}
                                                />
                                                <input type="file" ref={fileInputRef} onChange={handleFileChange} accept="image/*" className="hidden" />
                                                <button onClick={() => fileInputRef.current?.click()} className="bg-slate-700 hover:bg-slate-600 text-slate-300 p-4 rounded-2xl transition-colors" title="画像をアップロード">
                                                    <Upload size={20} />
                                                </button>
                                            </div>
                                            {newChar.imageUrl && (
                                                <div className="relative w-full h-32 bg-slate-900 rounded-xl overflow-hidden border border-slate-700 group">
                                                    <img src={newChar.imageUrl} className="w-full h-full object-contain" />
                                                    <button onClick={() => { setNewChar({...newChar, imageUrl: ''}); if (fileInputRef.current) fileInputRef.current.value = ''; }} className="absolute top-2 right-2 p-1 bg-black/50 hover:bg-red-500 rounded-full text-white transition-colors">
                                                        <X size={16} />
                                                    </button>
                                                    {isProcessingImage && <div className="absolute inset-0 bg-black/50 flex items-center justify-center"><div className="animate-spin rounded-full h-6 w-6 border-b-2 border-white"></div></div>}
                                                </div>
                                            )}
                                        </div>
                                        <div className="bg-slate-900/50 p-4 rounded-2xl border border-slate-700">
                                            <p className="text-xs text-slate-400 mb-3 font-bold uppercase tracking-widest">特徴タグ</p>
                                            <div className="flex flex-wrap gap-2 mb-4">
                                                {newChar.tags.map(t => (
                                                    <span key={t} className="text-xs bg-blue-600 text-white px-3 py-1.5 rounded-full flex items-center gap-2">
                                                        {t} <X size={14} className="cursor-pointer" onClick={() => setNewChar({...newChar, tags: newChar.tags.filter(tag => tag !== t)})} />
                                                    </span>
                                                ))}
                                            </div>
                                            <div className="grid grid-cols-2 gap-2">
                                                {suggestedTags.map(t => (
                                                    <button key={t} onClick={() => !newChar.tags.includes(t) && setNewChar({...newChar, tags: [...newChar.tags, t]})} className={`text-[11px] py-2 rounded-xl border transition-all ${newChar.tags.includes(t) ? 'bg-blue-600/20 border-blue-500 text-blue-300' : 'bg-slate-800 border-slate-700 text-slate-400 hover:border-slate-500'}`}>
                                                        {t}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                        <div className="flex gap-2">
                                            {editingCharId && (
                                                <button onClick={cancelEdit} className="flex-1 py-4 bg-slate-700 text-slate-300 rounded-2xl font-bold hover:bg-slate-600 transition-all">
                                                    キャンセル
                                                </button>
                                            )}
                                            <button onClick={saveCharacter} disabled={!newChar.name || isProcessingImage || !user} className="flex-[2] bg-blue-600 py-4 rounded-2xl font-black text-lg shadow-lg shadow-blue-900/40 hover:bg-blue-500 disabled:opacity-50 transition-all flex items-center justify-center gap-2">
                                                {isProcessingImage ? '処理中...' : (!user ? '接続エラー' : (editingCharId ? '更新する' : '保存する'))}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div className="space-y-3">
                                    <h3 className="text-xs font-black text-slate-500 uppercase tracking-widest px-2">登録済み ({characters.length})</h3>
                                    <div className="grid grid-cols-1 gap-3">
                                        {characters.map(c => (
                                            <div key={c.id} className={`bg-slate-800/50 p-3 rounded-2xl flex items-center gap-4 border transition-all ${editingCharId === c.id ? 'border-blue-500 bg-blue-900/20' : 'border-slate-700/50'}`}>
                                                <img src={c.imageUrl || "https://via.placeholder.com/150"} className="w-14 h-14 rounded-xl object-cover bg-slate-900" />
                                                <div className="flex-1 min-w-0">
                                                    <p className="font-bold text-sm truncate">{c.name}</p>
                                                    {c.source && <p className="text-xs text-slate-400 truncate">{c.source}</p>}
                                                    <div className="flex gap-1 overflow-x-auto no-scrollbar mt-1">{c.tags?.map(t => <span key={t} className="text-[9px] text-slate-500 bg-slate-900 px-1.5 py-0.5 rounded">#{t}</span>)}</div>
                                                </div>
                                                <div className="flex gap-1">
                                                    <button onClick={() => startEditCharacter(c)} className="p-2 text-blue-400 hover:text-blue-300 bg-blue-500/10 rounded-lg"><Edit2 size={16} /></button>
                                                    <button onClick={() => deleteCharacter(c.id)} className="p-2 text-slate-600 hover:text-red-400 hover:bg-red-500/10 rounded-lg"><Trash2 size={16} /></button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}
                        {mode === 'swipe' && (
                            swipeIndex < characters.length ? (
                                <div className="w-full max-w-sm h-[70vh] flex flex-col items-center justify-center relative">
                                    <div className="relative w-full h-full">
                                        {characters.slice(swipeIndex, swipeIndex + 2).reverse().map((char, i) => {
                                            const isTop = i === (characters.slice(swipeIndex, swipeIndex + 2).length - 1);
                                            return (
                                                <div key={char.id} className="absolute inset-0 bg-slate-800 rounded-[2.5rem] shadow-2xl border border-slate-700 overflow-hidden touch-none select-none transition-transform duration-200 ease-out" style={{transform: isTop ? `translate(${offsetX}px, ${offsetY}px) rotate(${offsetX * 0.05}deg) scale(1)` : `scale(0.92) translateY(20px)`, zIndex: isTop ? 20 : 10, opacity: isTop ? 1 : 0.4}} onMouseDown={isTop ? onStart : undefined} onMouseMove={isTop ? onMove : undefined} onMouseUp={isTop ? onEnd : undefined} onMouseLeave={isTop ? onEnd : undefined} onTouchStart={isTop ? onStart : undefined} onTouchMove={isTop ? onMove : undefined} onTouchEnd={isTop ? onEnd : undefined}>
                                                    <img src={char.imageUrl || "https://via.placeholder.com/400x600"} className="w-full h-3/4 object-cover pointer-events-none" />
                                                    <div className="absolute bottom-0 left-0 right-0 p-8 bg-gradient-to-t from-slate-900 via-slate-900/80 to-transparent">
                                                        <h2 className="text-3xl font-black mb-1">{char.name}</h2>
                                                        {char.source && <p className="text-sm text-slate-300 mb-2">{char.source}</p>}
                                                        <div className="flex flex-wrap gap-2">{char.tags?.map(t => (<span key={t} className="text-[10px] bg-white/10 backdrop-blur-md px-3 py-1 rounded-full text-white/80 border border-white/5 font-bold uppercase tracking-wider">#{t}</span>))}</div>
                                                    </div>
                                                    
                                                    {/* Overlay Indicators */}
                                                    {isTop && offsetX > 50 && Math.abs(offsetX) > Math.abs(offsetY) && <div className="absolute top-12 left-8 border-4 border-green-500 text-green-500 font-black text-4xl p-2 rounded-2xl rotate-[-20deg]" style={{opacity: Math.min(offsetX/150, 1)}}>嫌いじゃない</div>}
                                                    {isTop && offsetX < -50 && Math.abs(offsetX) > Math.abs(offsetY) && <div className="absolute top-12 right-8 border-4 border-orange-500 text-orange-500 font-black text-4xl p-2 rounded-2xl rotate-[20deg]" style={{opacity: Math.min(-offsetX/150, 1)}}>嫌い</div>}
                                                    {isTop && offsetY < -50 && Math.abs(offsetY) > Math.abs(offsetX) && (
                                                        <div className="absolute bottom-20 left-1/2 -translate-x-1/2 border-4 border-red-600 text-red-600 font-black text-4xl p-2 rounded-2xl" style={{opacity: Math.min(-offsetY/150, 1)}}>本当に嫌い</div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                    <div className="flex justify-between w-full max-w-sm mt-8 gap-4 px-4">
                                        <button onClick={() => handleDecision('dislike')} className="w-16 h-16 bg-white rounded-full flex items-center justify-center text-orange-500 shadow-xl border-4 border-slate-100 flex-col gap-1">
                                            <Frown size={24} />
                                            <span className="text-[9px] font-bold">嫌い</span>
                                        </button>
                                        <button onClick={() => handleDecision('super_dislike')} className="w-20 h-20 bg-red-600 rounded-full flex items-center justify-center text-white shadow-xl border-4 border-red-800 flex-col gap-1 -mt-4">
                                            <Skull size={32} />
                                            <span className="text-[10px] font-bold">本当に嫌い</span>
                                        </button>
                                        <button onClick={() => handleDecision('not_dislike')} className="w-16 h-16 bg-white rounded-full flex items-center justify-center text-green-500 shadow-xl border-4 border-slate-100 flex-col gap-1">
                                            <ThumbsUp size={24} />
                                            <span className="text-[9px] font-bold">Safe</span>
                                        </button>
                                    </div>
                                </div>
                            ) : (
                                <div className="text-center space-y-4">
                                    <div className="w-20 h-20 bg-green-500/20 text-green-500 rounded-full flex items-center justify-center mx-auto mb-6"><CheckCircle2 size={48} /></div>
                                    <h2 className="text-2xl font-black">完了！</h2>
                                    <button onClick={() => setMode('analysis')} className="px-8 py-4 bg-blue-600 rounded-2xl font-bold shadow-lg">分析を見る</button>
                                </div>
                            )
                        )}
                        {mode === 'analysis' && (
                            <div className="w-full max-w-md space-y-6 pb-24">
                                <div className="bg-slate-800 p-8 rounded-[2rem] border border-slate-700 shadow-2xl">
                                    <div className="flex justify-between items-start mb-8">
                                        <div><h2 className="text-2xl font-black flex items-center gap-2"><AlertCircle className="text-red-400" /> 分析結果</h2><p className="text-slate-400 text-sm mt-1">{myResults.length} 件のデータ</p></div>
                                        <div className="flex gap-2">
                                            <button onClick={resetMyResults} className="p-2 bg-red-600/20 text-red-400 rounded-lg hover:bg-red-600/40 transition-colors" title="結果を全削除してリセット">
                                                <Trash2 size={20} />
                                            </button>
                                            <button onClick={() => setMode('swipe')} className="p-2 text-slate-500 hover:text-white"><RotateCcw size={20} /></button>
                                        </div>
                                    </div>
                                    
                                    {/* AIレポート出力ボタン */}
                                    <button 
                                        onClick={generateAIReport} 
                                        className="w-full p-4 bg-gradient-to-r from-purple-600 to-blue-600 rounded-xl font-bold text-white shadow-lg flex flex-col items-center justify-center gap-2 mb-8 hover:opacity-90 transition-all text-sm whitespace-normal h-auto leading-relaxed border border-white/10"
                                    >
                                        <div className="flex items-center gap-2 text-lg">
                                            <Sparkles size={24} />
                                            <span>AIプロンプトをコピー</span>
                                        </div>
                                        <span className="text-xs opacity-80 font-normal">ChatGPTやGeminiに貼り付けて<br/>深層心理を分析してもらいましょう</span>
                                    </button>

                                    {/* グラフ表示 */}
                                    {analysis.length === 0 ? (<div className="text-center py-10 text-slate-500">データなし</div>) : (
                                        <SimplePieChart data={analysis} />
                                    )}

                                    {/* ギャラリー表示エリア */}
                                    <div>
                                        <div className="flex bg-slate-900/50 p-1 rounded-xl mb-4 overflow-x-auto">
                                            <button 
                                                onClick={() => setGalleryTab('super_dislike')}
                                                className={`flex-1 py-2 px-2 text-xs font-bold rounded-lg transition-all whitespace-nowrap ${galleryTab === 'super_dislike' ? 'bg-red-600 text-white shadow' : 'text-slate-500 hover:text-slate-300'}`}
                                            >
                                                本当に嫌い ({myResults.filter(r => r.rating === 'super_dislike').length})
                                            </button>
                                            <button 
                                                onClick={() => setGalleryTab('dislike')}
                                                className={`flex-1 py-2 px-2 text-xs font-bold rounded-lg transition-all whitespace-nowrap ${galleryTab === 'dislike' ? 'bg-orange-500/20 text-orange-400 shadow' : 'text-slate-500 hover:text-slate-300'}`}
                                            >
                                                嫌い ({myResults.filter(r => r.rating === 'dislike').length})
                                            </button>
                                            <button 
                                                onClick={() => setGalleryTab('not_dislike')} 
                                                className={`flex-1 py-2 px-2 text-xs font-bold rounded-lg transition-all whitespace-nowrap ${galleryTab === 'not_dislike' ? 'bg-green-500/20 text-green-400 shadow' : 'text-slate-500 hover:text-slate-300'}`}
                                            >
                                                Safe ({myResults.filter(r => r.rating === 'not_dislike' || r.rating === 'like').length})
                                            </button>
                                        </div>
                                        
                                        <div className="grid grid-cols-3 gap-2">
                                            {myResults
                                                .filter(r => {
                                                    if (galleryTab === 'not_dislike') return r.rating === 'not_dislike' || r.rating === 'like';
                                                    return r.rating === galleryTab;
                                                })
                                                .map((r, i) => {
                                                    const imgUrl = r.imageUrl || characters.find(c => c.id === r.characterId)?.imageUrl;
                                                    return (
                                                        <div key={i} className="aspect-[3/4] bg-slate-900 rounded-lg overflow-hidden relative border border-slate-700 group" onClick={() => setEditingResult(r)}>
                                                            {imgUrl ? (
                                                                <img src={imgUrl} className="w-full h-full object-cover opacity-70 group-hover:opacity-100 transition-opacity" />
                                                            ) : (
                                                                <div className="w-full h-full flex items-center justify-center text-slate-700"><ImageIcon size={20} /></div>
                                                            )}
                                                            <div className="absolute top-1 right-1 z-10 opacity-0 group-hover:opacity-100 transition-opacity">
                                                                <button onClick={(e) => deleteResult(r.id, e)} className="bg-red-500 text-white rounded-full p-1 shadow-lg hover:bg-red-600" title="判定を取り消す"><X size={12} /></button>
                                                            </div>
                                                            <div className="absolute top-1 left-1 z-10 opacity-0 group-hover:opacity-100 transition-opacity">
                                                                <button className="bg-blue-500 text-white rounded-full p-1 shadow-lg hover:bg-blue-600" title="判定を修正"><Edit2 size={12} /></button>
                                                            </div>
                                                            <div className="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-2">
                                                                <p className="text-[9px] text-white truncate">{r.characterName}</p>
                                                                {r.characterSource && <p className="text-[8px] text-slate-400 truncate">{r.characterSource}</p>}
                                                            </div>
                                                        </div>
                                                    );
                                                })
                                            }
                                            {myResults.filter(r => {
                                                if (galleryTab === 'not_dislike') return r.rating === 'not_dislike' || r.rating === 'like';
                                                return r.rating === galleryTab;
                                            }).length === 0 && (
                                                <div className="col-span-3 text-center py-10 text-slate-500 text-xs">
                                                    まだありません
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                        
                        {/* 編集モーダル */}
                        {editingResult && (
                            <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 animate-in fade-in" onClick={() => setEditingResult(null)}>
                                <div className="bg-slate-800 rounded-2xl p-6 w-full max-w-sm border border-slate-700 shadow-2xl" onClick={e => e.stopPropagation()}>
                                    <h3 className="text-xl font-bold mb-4 text-center">判定を修正</h3>
                                    <div className="flex justify-center mb-4">
                                        <div className="w-24 h-32 bg-slate-900 rounded-lg overflow-hidden">
                                            {editingResult.imageUrl ? (
                                                <img src={editingResult.imageUrl} className="w-full h-full object-cover" />
                                            ) : (
                                                <div className="w-full h-full flex items-center justify-center text-slate-700"><ImageIcon /></div>
                                            )}
                                        </div>
                                    </div>
                                    <p className="text-center font-bold mb-6">{editingResult.characterName}</p>
                                    <div className="flex flex-col gap-3">
                                        <button onClick={() => updateResult(editingResult.id, 'super_dislike')} className={`p-4 rounded-xl font-bold flex items-center justify-center gap-2 transition-all ${editingResult.rating === 'super_dislike' ? 'bg-red-600 ring-2 ring-white shadow-lg scale-105' : 'bg-slate-700 hover:bg-slate-600 text-slate-300'}`}>
                                            <Skull size={20} /> 本当に嫌い
                                        </button>
                                        <button onClick={() => updateResult(editingResult.id, 'dislike')} className={`p-4 rounded-xl font-bold flex items-center justify-center gap-2 transition-all ${editingResult.rating === 'dislike' ? 'bg-orange-500 ring-2 ring-white shadow-lg scale-105' : 'bg-slate-700 hover:bg-slate-600 text-slate-300'}`}>
                                            <Frown size={20} /> 嫌い
                                        </button>
                                        <button onClick={() => updateResult(editingResult.id, 'not_dislike')} className={`p-4 rounded-xl font-bold flex items-center justify-center gap-2 transition-all ${editingResult.rating === 'not_dislike' || editingResult.rating === 'like' ? 'bg-green-500 ring-2 ring-white shadow-lg scale-105' : 'bg-slate-700 hover:bg-slate-600 text-slate-300'}`}>
                                            <ThumbsUp size={20} /> Safe (嫌いじゃない)
                                        </button>
                                    </div>
                                    <button onClick={() => setEditingResult(null)} className="mt-6 w-full py-3 text-slate-500 font-bold hover:text-white transition-colors">キャンセル</button>
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        };
        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
