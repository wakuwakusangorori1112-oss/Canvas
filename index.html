<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Character Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.344.0",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
      }
    }
    </script>
</head>
<body class="bg-slate-900 text-white">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useMemo, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { 
            getAuth, 
            signInWithCustomToken,
            signInAnonymously, 
            onAuthStateChanged 
        } from 'firebase/auth';
        import { 
            getFirestore, 
            collection, 
            doc, 
            addDoc, 
            onSnapshot, 
            deleteDoc,
            writeBatch
        } from 'firebase/firestore';
        import { 
            Plus, Trash2, Tag, BarChart3, Play, Settings, RotateCcw, 
            Frown, Smile, Meh, AlertCircle, CheckCircle2, X, Search, User, Share2,
            Image as ImageIcon, Upload, Wifi, WifiOff, Database, ExternalLink, Lock,
            MessageCircle, FileText, Copy
        } from 'lucide-react';

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyCjLdydnVAYgHh0iKVtpskoy-W4HpFDDe4",
            authDomain: "test1-7c377a.firebaseapp.com",
            projectId: "test1-7c377a",
            storageBucket: "test1-7c377a.firebasestorage.app",
            messagingSenderId: "559194725567",
            appId: "1:559194725567:web:d6a3109709fe62ee8fba0a"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'char-analyzer-public'; 

        // --- エラーガイドコンポーネント ---
        const CriticalErrorGuide = ({ type }) => {
            if (type === 'firestore_not_created') {
                return (
                    <div className="fixed inset-0 bg-slate-900 z-50 flex flex-col items-center justify-center p-8 text-center overflow-y-auto">
                        <div className="bg-slate-800 p-8 rounded-3xl max-w-lg border border-red-500/30 shadow-2xl">
                            <div className="w-20 h-20 bg-red-500/20 text-red-500 rounded-full flex items-center justify-center mx-auto mb-6">
                                <Database size={40} />
                            </div>
                            <h2 className="text-2xl font-bold mb-4">データベースが見つかりません</h2>
                            <p className="text-slate-300 mb-6 leading-relaxed">
                                Firebaseコンソールでデータベースを作成してください。<br/>
                                作成済みの場合、反映に数分かかることがあります。
                            </p>
                            <button onClick={() => window.location.reload()} className="w-full py-3 bg-blue-600 rounded-xl font-bold hover:bg-blue-500 transition-colors">
                                再読み込み
                            </button>
                        </div>
                    </div>
                );
            }
            if (type === 'permission_denied') {
                return (
                    <div className="fixed inset-0 bg-slate-900 z-50 flex flex-col items-center justify-center p-8 text-center overflow-y-auto">
                        <div className="bg-slate-800 p-8 rounded-3xl max-w-lg border border-yellow-500/30 shadow-2xl">
                            <div className="w-20 h-20 bg-yellow-500/20 text-yellow-500 rounded-full flex items-center justify-center mx-auto mb-6">
                                <Lock size={40} />
                            </div>
                            <h2 className="text-2xl font-bold mb-4">書き込み権限がありません</h2>
                            <p className="text-slate-300 mb-4 leading-relaxed text-sm">
                                データベース作成時に「本番モード」を選んだ可能性があります。<br/>
                                以下の手順で「テストモード」に変更してください。
                            </p>
                            <div className="bg-slate-900 text-left p-6 rounded-xl border border-slate-700 text-xs space-y-2 mb-6 font-mono text-slate-400">
                                <p>1. Firebaseコンソールの「Firestore Database」を開く</p>
                                <p>2. 上部の<strong>「ルール (Rules)」</strong>タブをクリック</p>
                                <p>3. 以下のコードに書き換えて「公開」を押す：</p>
                                <div className="bg-black p-2 rounded text-green-400 my-2">
                                    allow read, write: if true;
                                </div>
                            </div>
                            <button onClick={() => window.location.reload()} className="w-full py-3 bg-yellow-600 rounded-xl font-bold hover:bg-yellow-500 transition-colors">
                                設定したら再読み込み
                            </button>
                        </div>
                    </div>
                );
            }
            return null;
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [characters, setCharacters] = useState([]);
            const [results, setResults] = useState([]);
            const [mode, setMode] = useState('setup');
            const [swipeIndex, setSwipeIndex] = useState(0);
            const [loading, setLoading] = useState(true);
            const [isProcessingImage, setIsProcessingImage] = useState(false);
            const [authError, setAuthError] = useState(null);
            const [criticalError, setCriticalError] = useState(null);
            const [galleryTab, setGalleryTab] = useState('dislike'); // 'dislike' or 'like'

            // スワイプ用
            const [offsetX, setOffsetX] = useState(0);
            const [isDragging, setIsDragging] = useState(false);
            const startX = useRef(0);

            // フォーム用
            const [newChar, setNewChar] = useState({ name: '', imageUrl: '', tags: [] });
            
            // タグリストを拡張
            const suggestedTags = [
                "不気味の谷", "目が笑っていない", "色が派手すぎ", "プロポーションが歪", 
                "あざとい", "無機質", "人間味がありすぎ", "左右非対称",
                "集合体", "粘液質", "爬虫類的", "ピエロ", "日本人形", 
                "目が大きすぎる", "動きが予測不能", "鋭利", "威圧的",
                "清潔感がない", "作り物めいている", "表情が固定"
            ];
            const fileInputRef = useRef(null);

            // 1. Authentication
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        await signInAnonymously(auth);
                    } catch (err) {
                        console.error("Auth error:", err);
                        if (err.code === 'auth/operation-not-allowed' || err.code === 'auth/admin-restricted-operation') {
                            setAuthError("Firebaseコンソールで「匿名ログイン(Anonymous)」が無効になっています。有効にしてください。");
                        } else {
                            setAuthError(`接続エラー: ${err.message}`);
                        }
                    }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, (user) => {
                    if (user) setUser(user);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            // 2. Real-time Data Sync
            useEffect(() => {
                if (!user) return;

                const handleError = (err) => {
                    console.error("Firestore Error:", err);
                    if (err.message && err.message.includes("Cloud Firestore API has not been used")) {
                        setCriticalError("firestore_not_created");
                    } else if (err.code === 'permission-denied') {
                        setCriticalError("permission_denied");
                    } else {
                        setAuthError(`読み込みエラー: ${err.message}`);
                    }
                };

                const charCol = collection(db, 'artifacts', appId, 'public', 'data', 'characters');
                const unsubChars = onSnapshot(charCol, (snapshot) => {
                    const charList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setCharacters(charList);
                    setAuthError(null);
                    setCriticalError(null); 
                }, handleError);

                const resultCol = collection(db, 'artifacts', appId, 'public', 'data', 'results');
                const unsubResults = onSnapshot(resultCol, (snapshot) => {
                    const resultList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setResults(resultList);
                }, handleError);

                return () => {
                    unsubChars();
                    unsubResults();
                };
            }, [user]);

            // 画像処理
            const processImage = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            const MAX_SIZE = 400; 
                            let width = img.width;
                            let height = img.height;
                            if (width > height) {
                                if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; }
                            } else {
                                if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; }
                            }
                            canvas.width = width;
                            canvas.height = height;
                            ctx.drawImage(img, 0, 0, width, height);
                            resolve(canvas.toDataURL('image/jpeg', 0.6));
                        };
                        img.onerror = reject;
                        img.src = e.target.result;
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            };

            const handleFileChange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                try {
                    setIsProcessingImage(true);
                    const base64Image = await processImage(file);
                    setNewChar(prev => ({ ...prev, imageUrl: base64Image }));
                } catch (err) {
                    alert("画像の処理に失敗しました。");
                } finally {
                    setIsProcessingImage(false);
                }
            };

            // Actions
            const saveCharacter = async () => {
                if (!newChar.name) return;
                if (!user) {
                    alert(authError || "ログイン処理中です。数秒待ってから再度お試しください。");
                    return;
                }
                try {
                    const charCol = collection(db, 'artifacts', appId, 'public', 'data', 'characters');
                    await addDoc(charCol, { ...newChar, createdAt: Date.now(), createdBy: user.uid });
                    setNewChar({ name: '', imageUrl: '', tags: [] });
                    alert("保存しました！");
                } catch (err) {
                    console.error("Save error:", err);
                    if (err.message.includes("exceeds the maximum allowed size")) {
                        alert("画像サイズが大きすぎます。別の画像を試してください。");
                    } else if (err.message.includes("Cloud Firestore API has not been used")) {
                         setCriticalError("firestore_not_created");
                    } else if (err.code === 'permission-denied') {
                         setCriticalError("permission_denied");
                    } else {
                        alert(`保存失敗: ${err.message}`);
                    }
                }
            };

            const deleteCharacter = async (id) => {
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'characters', id));
                } catch (err) {
                    console.error("Delete error:", err);
                }
            };

            // 結果削除機能
            const deleteResult = async (id) => {
                if (!confirm("この判定結果を削除しますか？\n（やり直したい場合はスワイプモードから再判定できます）")) return;
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'results', id));
                } catch (err) {
                    console.error("Delete result error:", err);
                    alert("削除に失敗しました");
                }
            };

            // 全結果リセット機能
            const resetMyResults = async () => {
                if (!confirm("あなたの分析結果を全て削除してリセットします。\nよろしいですか？")) return;
                if (!user) return;
                
                // バッチ処理で削除（ただし一度に500件まで）
                const batch = writeBatch(db);
                const myRes = results.filter(r => r.userId === user.uid);
                
                if (myRes.length === 0) {
                    alert("削除するデータがありません");
                    return;
                }

                myRes.forEach(r => {
                    const ref = doc(db, 'artifacts', appId, 'public', 'data', 'results', r.id);
                    batch.delete(ref);
                });

                try {
                    await batch.commit();
                    alert("リセットしました！");
                    setMode('swipe');
                    setSwipeIndex(0);
                } catch (err) {
                    console.error("Reset error:", err);
                    alert("リセットに失敗しました");
                }
            };

            const handleDecision = async (rating) => {
                if (swipeIndex >= characters.length) return;
                const char = characters[swipeIndex];
                setOffsetX(rating === 'like' ? 500 : -500);
                
                if (user) {
                    try {
                        const resultCol = collection(db, 'artifacts', appId, 'public', 'data', 'results');
                        await addDoc(resultCol, {
                            characterId: char.id,
                            characterName: char.name,
                            imageUrl: char.imageUrl,
                            tags: char.tags,
                            rating: rating,
                            userId: user.uid,
                            timestamp: Date.now()
                        });
                    } catch (err) {
                        console.error("Result save error:", err);
                    }
                }

                setTimeout(() => {
                    setOffsetX(0);
                    if (swipeIndex < characters.length - 1) {
                        setSwipeIndex(prev => prev + 1);
                    } else {
                        setMode('analysis');
                    }
                }, 200);
            };

            // 分析コメント生成ロジック
            const getAnalysisComment = (topTag) => {
                const comments = {
                    "不気味の谷": "人間と非人間の境界にある『中途半端なリアルさ』に対し、本能的な警戒心が強いタイプです。生存本能が正常に働いている証拠でもあります。",
                    "目が笑っていない": "相手の感情や本心が読み取れない状況に対し、強いストレスを感じる感受性をお持ちです。誠実さを重視する傾向があります。",
                    "色が派手すぎ": "視覚的な刺激に対して敏感で、調和や落ち着きを好む傾向があります。繊細な美的感覚の持ち主かもしれません。",
                    "プロポーションが歪": "身体的な違和感や生理的なバランスの崩れに対して、鋭い察知能力を持っています。整った秩序を愛するタイプです。",
                    "あざとい": "作られた感情表現や計算高さを見抜く力が強く、嘘偽りのないコミュニケーションを求めています。",
                    "無機質": "温かみや生命感の欠如に対して、寂しさや恐怖を感じ取りやすい、共感性の高い感受性があります。",
                    "集合体": "微細なパターンの繰り返しに対して、生理的な嫌悪感を抱きやすい防衛本能があります。",
                    "ピエロ": "『隠された素顔』や『表情と行動の乖離』に対して強い恐怖心を持つ傾向があります。予測不能な事態を避けたがります。",
                    "日本人形": "魂が宿っているような静けさに対して、見透かされているような不安を感じる感受性があります。",
                    "目が大きすぎる": "現実離れした誇張表現に対し、違和感を感じやすいリアリストな一面があるかもしれません。",
                    "爬虫類的": "冷たさや感情の欠落を連想させる特徴に対し、生理的な拒絶反応が出やすいタイプです。"
                };
                return comments[topTag] || "特定の視覚的特徴に対して、強い自己防衛本能が働いています。この特徴を持つ対象を避けることで、心理的な安定を保とうとしているようです。";
            };

            // AI分析用レポート生成
            const generateAIReport = () => {
                if (!analysis || analysis.length === 0) return;
                
                let report = "【キャラクター苦手傾向分析データ】\n";
                report += "以下のデータを元に、この人の深層心理や、なぜこういった特徴を不気味に感じるのか、心理学的・美学的な観点から分析してください。\n\n";
                report += "■苦手な要素トップランキング\n";
                analysis.forEach(([tag, count], index) => {
                    report += `${index + 1}. ${tag}: ${count}回\n`;
                });
                
                report += "\n■特に苦手と判定したキャラクターの特徴\n";
                const dislikeChars = myResults.filter(r => r.rating === 'dislike').slice(0, 10);
                dislikeChars.forEach(c => {
                    report += `- ${c.characterName} (タグ: ${c.tags ? c.tags.join(', ') : 'なし'})\n`;
                });

                navigator.clipboard.writeText(report).then(() => {
                    alert("AI分析用プロンプトをコピーしました！\nChatGPTやGeminiに貼り付けて聞いてみてください。");
                });
            };

            const onStart = (e) => { setIsDragging(true); startX.current = e.type.includes('touch') ? e.touches[0].clientX : e.clientX; };
            const onMove = (e) => { if (!isDragging) return; const currentX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX; setOffsetX(currentX - startX.current); };
            const onEnd = () => { if (!isDragging) return; setIsDragging(false); if (offsetX > 100) handleDecision('like'); else if (offsetX < -100) handleDecision('dislike'); else setOffsetX(0); };

            // ユーザー個人の結果のみを抽出
            const myResults = useMemo(() => {
                if (!user) return [];
                return results.filter(r => r.userId === user.uid);
            }, [results, user]);

            const analysis = useMemo(() => {
                const dislikeResults = myResults.filter(r => r.rating === 'dislike');
                const tagCounts = {};
                dislikeResults.forEach(r => { r.tags?.forEach(tag => { tagCounts[tag] = (tagCounts[tag] || 0) + 1; }); });
                return Object.entries(tagCounts).sort((a, b) => b[1] - a[1]).slice(0, 10);
            }, [myResults]);

            if (criticalError) return <CriticalErrorGuide type={criticalError} />;
            if (loading) return <div className="min-h-screen bg-slate-900 flex items-center justify-center text-white">読み込み中...</div>;

            return (
                <div className="min-h-screen bg-slate-900 text-white font-sans overflow-hidden flex flex-col">
                    <header className="p-4 border-b border-slate-800 flex justify-between items-center bg-slate-900/80 backdrop-blur-md z-30">
                        <h1 className="text-xl font-black tracking-tighter flex items-center gap-2">
                            <div className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center italic">C</div>
                            CHAR-LAB
                        </h1>
                        <div className="flex items-center gap-2">
                            {user ? (
                                <div className="text-xs text-green-400 flex items-center gap-1 bg-green-900/20 px-2 py-1 rounded-full border border-green-900">
                                    <Wifi size={12} /> Online
                                </div>
                            ) : (
                                <div className="text-xs text-red-400 flex items-center gap-1 bg-red-900/20 px-2 py-1 rounded-full border border-red-900 animate-pulse">
                                    <WifiOff size={12} /> Connecting...
                                </div>
                            )}
                            <div className="flex bg-slate-800 p-1 rounded-xl ml-2">
                                <button onClick={() => setMode('setup')} className={`p-2 rounded-lg transition-all ${mode === 'setup' ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-400'}`}><Settings size={20} /></button>
                                <button onClick={() => { setSwipeIndex(0); setMode('swipe'); }} className={`p-2 rounded-lg transition-all ${mode === 'swipe' ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-400'}`}><Play size={20} /></button>
                                <button onClick={() => setMode('analysis')} className={`p-2 rounded-lg transition-all ${mode === 'analysis' ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-400'}`}><BarChart3 size={20} /></button>
                            </div>
                        </div>
                    </header>

                    {authError && (
                        <div className="bg-red-500/10 border-b border-red-500/50 p-2 text-center text-red-200 text-xs">
                            <p className="font-bold flex items-center justify-center gap-2">
                                <AlertCircle size={14} /> {authError}
                            </p>
                        </div>
                    )}

                    <main className="flex-1 relative flex flex-col items-center justify-center p-4 overflow-y-auto">
                        {mode === 'setup' && (
                            <div className="w-full max-w-md space-y-6 pb-24">
                                <div className="bg-slate-800 p-6 rounded-3xl border border-slate-700 shadow-xl">
                                    <h2 className="text-lg font-bold mb-4 flex items-center gap-2 text-blue-400">
                                        <Plus size={20} /> 分析対象を登録
                                    </h2>
                                    <div className="space-y-4">
                                        <input 
                                            placeholder="キャラ名"
                                            className="w-full bg-slate-700 border-none rounded-2xl p-4 text-white placeholder:text-slate-500 focus:ring-2 focus:ring-blue-500"
                                            value={newChar.name}
                                            onChange={e => setNewChar({...newChar, name: e.target.value})}
                                        />
                                        <div className="space-y-2">
                                            <div className="flex gap-2">
                                                <input 
                                                    placeholder="画像URL"
                                                    className="flex-1 bg-slate-700 border-none rounded-2xl p-4 text-white placeholder:text-slate-500 focus:ring-2 focus:ring-blue-500 text-sm"
                                                    value={newChar.imageUrl.startsWith('data:') ? '' : newChar.imageUrl}
                                                    onChange={e => setNewChar({...newChar, imageUrl: e.target.value})}
                                                    disabled={newChar.imageUrl.startsWith('data:')}
                                                />
                                                <input type="file" ref={fileInputRef} onChange={handleFileChange} accept="image/*" className="hidden" />
                                                <button onClick={() => fileInputRef.current?.click()} className="bg-slate-700 hover:bg-slate-600 text-slate-300 p-4 rounded-2xl transition-colors" title="画像をアップロード">
                                                    <Upload size={20} />
                                                </button>
                                            </div>
                                            {newChar.imageUrl && (
                                                <div className="relative w-full h-32 bg-slate-900 rounded-xl overflow-hidden border border-slate-700 group">
                                                    <img src={newChar.imageUrl} className="w-full h-full object-contain" />
                                                    <button onClick={() => { setNewChar({...newChar, imageUrl: ''}); if (fileInputRef.current) fileInputRef.current.value = ''; }} className="absolute top-2 right-2 p-1 bg-black/50 hover:bg-red-500 rounded-full text-white transition-colors">
                                                        <X size={16} />
                                                    </button>
                                                    {isProcessingImage && <div className="absolute inset-0 bg-black/50 flex items-center justify-center"><div className="animate-spin rounded-full h-6 w-6 border-b-2 border-white"></div></div>}
                                                </div>
                                            )}
                                        </div>
                                        <div className="bg-slate-900/50 p-4 rounded-2xl border border-slate-700">
                                            <p className="text-xs text-slate-400 mb-3 font-bold uppercase tracking-widest">特徴タグ</p>
                                            <div className="flex flex-wrap gap-2 mb-4">
                                                {newChar.tags.map(t => (
                                                    <span key={t} className="text-xs bg-blue-600 text-white px-3 py-1.5 rounded-full flex items-center gap-2">
                                                        {t} <X size={14} className="cursor-pointer" onClick={() => setNewChar({...newChar, tags: newChar.tags.filter(tag => tag !== t)})} />
                                                    </span>
                                                ))}
                                            </div>
                                            <div className="grid grid-cols-2 gap-2">
                                                {suggestedTags.map(t => (
                                                    <button key={t} onClick={() => !newChar.tags.includes(t) && setNewChar({...newChar, tags: [...newChar.tags, t]})} className={`text-[11px] py-2 rounded-xl border transition-all ${newChar.tags.includes(t) ? 'bg-blue-600/20 border-blue-500 text-blue-300' : 'bg-slate-800 border-slate-700 text-slate-400 hover:border-slate-500'}`}>
                                                        {t}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                        <button onClick={saveCharacter} disabled={!newChar.name || isProcessingImage || !user} className="w-full bg-blue-600 py-4 rounded-2xl font-black text-lg shadow-lg shadow-blue-900/40 hover:bg-blue-500 disabled:opacity-50 transition-all flex items-center justify-center gap-2">
                                            {isProcessingImage ? '処理中...' : (!user ? '接続エラー' : '保存')}
                                        </button>
                                    </div>
                                </div>
                                <div className="space-y-3">
                                    <h3 className="text-xs font-black text-slate-500 uppercase tracking-widest px-2">登録済み ({characters.length})</h3>
                                    <div className="grid grid-cols-1 gap-3">
                                        {characters.map(c => (
                                            <div key={c.id} className="bg-slate-800/50 p-3 rounded-2xl flex items-center gap-4 border border-slate-700/50">
                                                <img src={c.imageUrl || "https://via.placeholder.com/150"} className="w-14 h-14 rounded-xl object-cover" />
                                                <div className="flex-1 min-w-0">
                                                    <p className="font-bold text-sm truncate">{c.name}</p>
                                                    <div className="flex gap-1 overflow-x-auto no-scrollbar mt-1">{c.tags?.map(t => <span key={t} className="text-[9px] text-slate-500 bg-slate-900 px-1.5 py-0.5 rounded">#{t}</span>)}</div>
                                                </div>
                                                <button onClick={() => deleteCharacter(c.id)} className="p-2 text-slate-600 hover:text-red-400"><Trash2 size={18} /></button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}
                        {mode === 'swipe' && (
                            swipeIndex < characters.length ? (
                                <div className="w-full max-w-sm h-[70vh] flex flex-col items-center justify-center relative">
                                    <div className="relative w-full h-full">
                                        {characters.slice(swipeIndex, swipeIndex + 2).reverse().map((char, i) => {
                                            const isTop = i === (characters.slice(swipeIndex, swipeIndex + 2).length - 1);
                                            return (
                                                <div key={char.id} className="absolute inset-0 bg-slate-800 rounded-[2.5rem] shadow-2xl border border-slate-700 overflow-hidden touch-none select-none transition-transform duration-200 ease-out" style={{transform: isTop ? `translateX(${offsetX}px) rotate(${offsetX * 0.05}deg) scale(1)` : `scale(0.92) translateY(20px)`, zIndex: isTop ? 20 : 10, opacity: isTop ? 1 : 0.4}} onMouseDown={isTop ? onStart : undefined} onMouseMove={isTop ? onMove : undefined} onMouseUp={isTop ? onEnd : undefined} onMouseLeave={isTop ? onEnd : undefined} onTouchStart={isTop ? onStart : undefined} onTouchMove={isTop ? onMove : undefined} onTouchEnd={isTop ? onEnd : undefined}>
                                                    <img src={char.imageUrl || "https://via.placeholder.com/400x600"} className="w-full h-3/4 object-cover pointer-events-none" />
                                                    <div className="absolute bottom-0 left-0 right-0 p-8 bg-gradient-to-t from-slate-900 via-slate-900/80 to-transparent">
                                                        <h2 className="text-3xl font-black mb-2">{char.name}</h2>
                                                        <div className="flex flex-wrap gap-2">{char.tags?.map(t => (<span key={t} className="text-[10px] bg-white/10 backdrop-blur-md px-3 py-1 rounded-full text-white/80 border border-white/5 font-bold uppercase tracking-wider">#{t}</span>))}</div>
                                                    </div>
                                                    {isTop && offsetX > 50 && <div className="absolute top-12 left-8 border-4 border-green-500 text-green-500 font-black text-5xl p-2 rounded-2xl rotate-[-20deg]" style={{opacity: Math.min(offsetX/150, 1)}}>LIKE</div>}
                                                    {isTop && offsetX < -50 && <div className="absolute top-12 right-8 border-4 border-red-500 text-red-500 font-black text-5xl p-2 rounded-2xl rotate-[20deg]" style={{opacity: Math.min(-offsetX/150, 1)}}>苦手</div>}
                                                </div>
                                            );
                                        })}
                                    </div>
                                    <div className="flex gap-8 mt-10">
                                        <button onClick={() => handleDecision('dislike')} className="w-20 h-20 bg-white rounded-full flex items-center justify-center text-red-500 shadow-2xl active:scale-90 transition-transform"><Frown size={40} /></button>
                                        <button onClick={() => handleDecision('like')} className="w-20 h-20 bg-blue-600 rounded-full flex items-center justify-center text-white shadow-2xl active:scale-90 transition-transform"><Smile size={40} /></button>
                                    </div>
                                </div>
                            ) : (
                                <div className="text-center space-y-4">
                                    <div className="w-20 h-20 bg-green-500/20 text-green-500 rounded-full flex items-center justify-center mx-auto mb-6"><CheckCircle2 size={48} /></div>
                                    <h2 className="text-2xl font-black">完了！</h2>
                                    <button onClick={() => setMode('analysis')} className="px-8 py-4 bg-blue-600 rounded-2xl font-bold shadow-lg">分析を見る</button>
                                </div>
                            )
                        )}
                        {mode === 'analysis' && (
                            <div className="w-full max-w-md space-y-6 pb-24">
                                <div className="bg-slate-800 p-8 rounded-[2rem] border border-slate-700 shadow-2xl">
                                    <div className="flex justify-between items-start mb-8">
                                        <div><h2 className="text-2xl font-black flex items-center gap-2"><AlertCircle className="text-red-400" /> 分析結果</h2><p className="text-slate-400 text-sm mt-1">{myResults.length} 件のデータ</p></div>
                                        <div className="flex gap-2">
                                            {/* AIレポート出力ボタン */}
                                            <button onClick={generateAIReport} className="p-2 bg-blue-600/20 text-blue-400 rounded-lg hover:bg-blue-600/40 transition-colors" title="AI分析用レポートをコピー">
                                                <FileText size={20} />
                                            </button>
                                            {/* リセットボタン */}
                                            <button onClick={resetMyResults} className="p-2 bg-red-600/20 text-red-400 rounded-lg hover:bg-red-600/40 transition-colors" title="結果を全削除してリセット">
                                                <Trash2 size={20} />
                                            </button>
                                            <button onClick={() => setMode('swipe')} className="p-2 text-slate-500 hover:text-white"><RotateCcw size={20} /></button>
                                        </div>
                                    </div>
                                    
                                    {/* 分析コメント表示エリア */}
                                    {analysis.length > 0 && (
                                        <div className="bg-slate-900/50 p-5 rounded-2xl mb-8 border border-slate-700 relative overflow-hidden">
                                            <div className="absolute top-0 right-0 w-20 h-20 bg-blue-500/10 rounded-full -mr-10 -mt-10 blur-xl"></div>
                                            <h3 className="font-bold text-blue-400 flex items-center gap-2 mb-3 text-sm">
                                                <MessageCircle size={16} /> 分析レポート
                                            </h3>
                                            <p className="text-sm leading-relaxed text-slate-300">
                                                <span className="font-bold text-white block mb-2">最も多い反応：「{analysis[0][0]}」</span>
                                                {getAnalysisComment(analysis[0][0])}
                                            </p>
                                        </div>
                                    )}

                                    {/* グラフ表示 */}
                                    {analysis.length === 0 ? (<div className="text-center py-10 text-slate-500">データなし</div>) : (
                                        <div className="space-y-6 mb-10">
                                            {analysis.map(([tag, count]) => {
                                                const dislikeTotal = myResults.filter(r => r.rating === 'dislike').length;
                                                const percent = dislikeTotal > 0 ? Math.round((count / dislikeTotal) * 100) : 0;
                                                return (
                                                    <div key={tag} className="group">
                                                        <div className="flex justify-between text-sm mb-2"><span className="font-black tracking-tight text-slate-200">{tag}</span><span className="text-slate-500 font-mono">{percent}%</span></div>
                                                        <div className="w-full bg-slate-900 rounded-full h-3 overflow-hidden border border-slate-700"><div className="bg-gradient-to-r from-red-600 to-orange-500 h-full rounded-full transition-all duration-1000 ease-out" style={{ width: `${percent}%` }}></div></div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    )}

                                    {/* ギャラリー表示エリア */}
                                    <div>
                                        <div className="flex bg-slate-900/50 p-1 rounded-xl mb-4">
                                            <button 
                                                onClick={() => setGalleryTab('dislike')}
                                                className={`flex-1 py-2 text-sm font-bold rounded-lg transition-all ${galleryTab === 'dislike' ? 'bg-red-500/20 text-red-400 shadow' : 'text-slate-500 hover:text-slate-300'}`}
                                            >
                                                苦手 ({myResults.filter(r => r.rating === 'dislike').length})
                                            </button>
                                            <button 
                                                onClick={() => setGalleryTab('like')}
                                                className={`flex-1 py-2 text-sm font-bold rounded-lg transition-all ${galleryTab === 'like' ? 'bg-green-500/20 text-green-400 shadow' : 'text-slate-500 hover:text-slate-300'}`}
                                            >
                                                LIKE ({myResults.filter(r => r.rating === 'like').length})
                                            </button>
                                        </div>
                                        
                                        <div className="grid grid-cols-3 gap-2">
                                            {myResults
                                                .filter(r => r.rating === galleryTab)
                                                .map((r, i) => {
                                                    // 結果データに画像がない場合は、キャラリストから探すフォールバック
                                                    const imgUrl = r.imageUrl || characters.find(c => c.id === r.characterId)?.imageUrl;
                                                    
                                                    return (
                                                        <div key={i} className="aspect-[3/4] bg-slate-900 rounded-lg overflow-hidden relative border border-slate-700 group">
                                                            {imgUrl ? (
                                                                <img src={imgUrl} className="w-full h-full object-cover opacity-70 group-hover:opacity-100 transition-opacity" />
                                                            ) : (
                                                                <div className="w-full h-full flex items-center justify-center text-slate-700"><ImageIcon size={20} /></div>
                                                            )}
                                                            <div className="absolute top-1 right-1 z-10 opacity-0 group-hover:opacity-100 transition-opacity">
                                                                <button 
                                                                    onClick={() => deleteResult(r.id)} 
                                                                    className="bg-red-500 text-white rounded-full p-1 shadow-lg hover:bg-red-600"
                                                                    title="判定を取り消す"
                                                                >
                                                                    <X size={12} />
                                                                </button>
                                                            </div>
                                                            <div className="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-2">
                                                                <p className="text-[9px] text-white truncate">{r.characterName}</p>
                                                            </div>
                                                        </div>
                                                    );
                                                })
                                            }
                                            {myResults.filter(r => r.rating === galleryTab).length === 0 && (
                                                <div className="col-span-3 text-center py-10 text-slate-500 text-xs">
                                                    まだ{galleryTab === 'dislike' ? '苦手' : 'LIKE'}したキャラがいません
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        };
        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
